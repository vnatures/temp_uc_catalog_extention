# name: test/sql/databricks/tpcds.test_slow
# description: test
# group: [databricks]

require parquet

require unity_catalog

require delta

require tpcds

require httpfs

require-env DATABRICKS_TOKEN

require-env DATABRICKS_ENDPOINT

require-env DATABRICKS_REGION

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
CREATE SECRET (
    TYPE UNITY_CATALOG,
    TOKEN '${DATABRICKS_TOKEN}',
    ENDPOINT '${DATABRICKS_ENDPOINT}',
    AWS_REGION '${DATABRICKS_REGION}'
);

# Attach to databricks through the unity catalog API
statement ok
ATTACH 'duckdblabs_testing' (TYPE UNITY_CATALOG, DEFAULT_SCHEMA 'main');

# Register tpcds views
foreach table call_center catalog_page catalog_returns catalog_sales customer customer_demographics customer_address date_dim household_demographics inventory income_band item promotion reason ship_mode store store_returns store_sales time_dim warehouse web_page web_returns web_sales web_site

statement ok
create view ${table}_delta as from duckdblabs_testing.main.tpcds_sf0_01_${table};;

# NOTE: switch this to _parquet to easily compare plans while debugging
statement ok
create view ${table} as from ${table}_delta

endloop

loop i 1 9

query I
PRAGMA tpcds(${i})
----
<FILE>:duckdb/extension/tpcds/dsdgen/answers/sf0.01/0${i}.csv

endloop

loop i 10 99

query I
PRAGMA tpcds(${i})
----
<FILE>:duckdb/extension/tpcds/dsdgen/answers/sf0.01/${i}.csv

endloop
