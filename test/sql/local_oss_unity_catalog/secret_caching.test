# name: test/sql/local_oss_unity_catalog/secret_caching.test
# description: test secret caching and expiration for uc_catalog
# group: [local_oss_unity_catalog]

# Require statement will ensure this test is run with this extension loaded
require parquet

require uc_catalog

require delta

require httpfs

require-env UC_TEST_SERVER_RUNNING

statement ok
CREATE SECRET (
    TYPE UC,
    TOKEN 'not-used',
    ENDPOINT 'http://127.0.0.1:8080',
    AWS_REGION 'us-east-2'
);

# Attach catalog with default schema
statement ok
ATTACH 'unity' AS my_catalog (TYPE UC_CATALOG, DEFAULT_SCHEMA 'default');

statement ok
USE my_catalog;

# First query - should fetch credentials and cache them
query III
FROM marksheet LIMIT 5;
----
1	nWYHawtqUw	930
2	uvOzzthsLV	166
3	WIAehuXWkv	170
4	wYCSvnJKTo	709
5	VsslXsUIDZ	993

# Second query to the same table - should use cached credentials (no new API call)
# This verifies that the secret caching is working
query III
FROM marksheet LIMIT 5;
----
1	nWYHawtqUw	930
2	uvOzzthsLV	166
3	WIAehuXWkv	170
4	wYCSvnJKTo	709
5	VsslXsUIDZ	993

# Query a different table - should also use cached credentials if they're still valid
query II
FROM numbers LIMIT 5;
----
564	188.75535598441473
755	883.6105633023361
644	203.4395591086936
75	277.8802190765611
42	403.857969425109

# Multiple concurrent-like queries to verify mutex locking works correctly
query III
FROM marksheet WHERE column0 < 3;
----
1	nWYHawtqUw	930
2	uvOzzthsLV	166

query III
FROM marksheet WHERE column0 >= 3 AND column0 < 6;
----
3	WIAehuXWkv	170
4	wYCSvnJKTo	709
5	VsslXsUIDZ	993

# Cleanup
statement ok
USE memory; DETACH my_catalog


